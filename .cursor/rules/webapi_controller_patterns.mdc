---
description: WebAPI controller patterns and conventions
globs: app__webapi/**/*.py
alwaysApply: true
---

# WebAPI Controller Patterns

## File Naming

- **Controller files**: Must use `__controller` suffix: `walnut_pairings__controller.py`
- **Location**: All controllers in `app__webapi/controllers/` directory
- **Route constants**: All route paths defined in `app__webapi/routes.py`

## Function Naming

- **All async functions**: MUST have `_async` suffix
- Example: `async def get_all_pairings_async(...)`

## Route Constants

- All route paths MUST be defined as constants in `app__webapi/routes.py`
- Use constants in router decorators: `@router.get(ROUTE_CONSTANT)`
- Format: `WALNUT_PAIRINGS_BASE`, `WALNUT_PAIRINGS_LIST`, etc.

Example:
```python
# app__webapi/routes.py
WALNUT_PAIRINGS_LIST: Final[str] = "/"

# app__webapi/controllers/walnut_pairings__controller.py
@router.get(WALNUT_PAIRINGS_LIST)
async def get_all_pairings_async(...):
    ...
```

## DTO Flow (CRITICAL)

**Controllers MUST ONLY work with DTOs, never DAOs or Domain objects:**

1. **Query services return DTOs**: `query.get_all_pairings_async()` returns `List[WalnutComparisonDTO]`
2. **Controllers receive DTOs**: Controllers get DTOs from query services
3. **DTOs ARE response models**: DTOs are used directly as FastAPI response models (no conversion needed)
4. **Data flow**: DAO → Domain (via mapper, optional) → DTO (via mapper) → Controller → Response

Example:
```python
# ✅ Good: Query returns DTO, DTO is used directly as response
@router.get("/", response_model=List[WalnutComparisonDTO])
async def get_all_pairings_async(
    query: IWalnutComparisonQuery = Depends(get_walnut_comparison_query),
) -> List[WalnutComparisonDTO]:
    return await query.get_all_pairings_async()  # Returns DTOs, used directly

# ❌ Bad: Query returns DAO
async def get_all_pairings_async(
    query: IWalnutComparisonQuery = Depends(get_walnut_comparison_query),
) -> List[WalnutComparisonDTO]:
    daos = await query.get_all_pairings_async()  # Returns DAOs - WRONG!
    return daos
```

## Dependency Injection Scopes

- **Singleton**: Configuration, factories (shared across all requests)
- **Request**: Database sessions, readers, queries (one per HTTP request)
- **Transient**: Can be added as needed

## Response Models

- **DTOs ARE the response models**: Use DTOs directly as response models in FastAPI
- DTOs should be Pydantic `BaseModel` classes (not dataclasses) when used in WebAPI controllers
- No need to create separate response classes - the DTO serves as the response model
- FastAPI will automatically serialize DTOs to JSON
